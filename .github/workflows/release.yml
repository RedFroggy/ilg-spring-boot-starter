name: Release with Semantic Release

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install Semantic Release and plugins
              run: npm install -g semantic-release @semantic-release/exec @semantic-release/changelog @semantic-release/git @semantic-release/github

            - name: Prepare Maven for deployment
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'
                  server-id: 'ossrh' # Must match <id> in distributionManagement
                  server-username: 'OSSRH_USERNAME'
                  server-password: 'OSSRH_PASSWORD'
                  gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
                  gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}

            - name: Run tests
              run: ./mvnw test

            - name: Run Semantic Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
                  NEXUS_USERNAME: ${{ secrets.OSSRH_USERNAME }}
                  NEXUS_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
                  GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
              run: |
                  semantic-release
